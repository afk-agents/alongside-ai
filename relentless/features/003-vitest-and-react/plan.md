# Implementation Plan: Testing Infrastructure

**Branch**: `003-vitest-and-react` | **Date**: 2026-01-16 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `relentless/features/003-vitest-and-react/spec.md`

## Summary

Establish a complete testing infrastructure using Vitest and React Testing Library that enables TDD workflow for the Alongside AI project. The implementation will configure Vitest with jsdom environment, integrate React Testing Library with custom matchers, set up path alias resolution, and provide sample tests demonstrating patterns for component and utility testing.

## Technical Context

**Language/Version**: TypeScript 5.x
**Primary Dependencies**: Vitest 3.x, @testing-library/react 16.x, @testing-library/jest-dom 6.x, @testing-library/user-event 14.x, jsdom 26.x
**Storage**: N/A (testing infrastructure only)
**Testing**: Vitest (this feature establishes the testing framework)
**Target Platform**: Node.js (Bun runtime) for test execution
**Project Type**: Web application (Next.js 16 + Convex)
**Performance Goals**: Test suite startup < 5 seconds, watch mode re-run < 2 seconds
**Constraints**: Must work with Bun, React 19, Next.js 16, and existing path aliases
**Scale/Scope**: Testing ~15 existing components, utilities, and future code

## Constitution Check

*GATE: Must pass before implementation. All items verified.*

| Principle | Status | Notes |
|-----------|--------|-------|
| Type Safety | ✅ | Vitest has excellent TypeScript support, all config files will be typed |
| Testing (TDD) | ✅ | This feature enables TDD - core infrastructure requirement |
| Code Quality | ✅ | Test command added to quality gates |
| Dependencies | ✅ | All packages are well-maintained, justified for testing (required by constitution) |

**Violations:** None

## Project Structure

### Documentation (this feature)

```text
relentless/features/003-vitest-and-react/
├── spec.md              # Feature specification
├── plan.md              # This file
├── tasks.md             # User stories (generated by /relentless.tasks)
├── checklist.md         # Quality checklist
└── progress.txt         # Implementation progress log
```

### Source Code (repository root)

```text
alongside-ai/
├── vitest.config.ts           # NEW: Vitest configuration
├── vitest.setup.ts            # NEW: Test setup (jest-dom, cleanup)
├── package.json               # MODIFIED: Add test scripts and dependencies
├── tsconfig.json              # UNCHANGED: Vitest uses existing config
│
├── __tests__/                 # NEW: Test directory
│   ├── setup/                 # Test utilities and mocks
│   │   ├── test-utils.tsx     # Custom render with providers
│   │   └── mocks/
│   │       └── convex.ts      # Convex client mocks
│   │
│   ├── components/            # Component tests (mirrors components/)
│   │   └── auth/
│   │       └── SignOutButton.test.tsx
│   │
│   └── lib/                   # Utility function tests
│       └── example.test.ts    # Sample utility test
│
├── components/                # EXISTING: React components
│   └── auth/
│       └── SignOutButton.tsx
│
└── lib/                       # NEW: Shared utilities (if needed)
    └── example.ts             # Sample utility for testing demo
```

**Structure Decision**: Test files live in `__tests__/` directory mirroring source structure. This keeps tests separate from source while maintaining clear correspondence between test and implementation files.

## Technical Design

### 1. Vitest Configuration

**File: `vitest.config.ts`**

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./vitest.setup.ts'],
    include: ['**/*.{test,spec}.{ts,tsx}'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'html', 'lcov'],
      include: ['app/**/*.{ts,tsx}', 'components/**/*.{ts,tsx}', 'lib/**/*.{ts,tsx}'],
      exclude: ['**/*.d.ts', '**/*.test.{ts,tsx}', 'convex/_generated/**'],
    },
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './'),
    },
  },
});
```

Key decisions:
- `globals: true` - Provides Jest-compatible global API (`describe`, `it`, `expect`)
- `environment: 'jsdom'` - DOM environment for React component testing
- `setupFiles` - Runs before each test file for common setup
- Path alias matches existing `tsconfig.json` paths

### 2. Test Setup File

**File: `vitest.setup.ts`**

```typescript
import '@testing-library/jest-dom/vitest';
import { cleanup } from '@testing-library/react';
import { afterEach } from 'vitest';

// Automatic cleanup after each test
afterEach(() => {
  cleanup();
});
```

### 3. Custom Test Utilities

**File: `__tests__/setup/test-utils.tsx`**

```typescript
import { render, RenderOptions } from '@testing-library/react';
import { ReactElement, ReactNode } from 'react';

// Wrapper for providers (Convex, etc.)
function AllProviders({ children }: { children: ReactNode }) {
  // Add providers here as needed (e.g., mocked ConvexProvider)
  return <>{children}</>;
}

// Custom render that includes providers
function customRender(
  ui: ReactElement,
  options?: Omit<RenderOptions, 'wrapper'>
) {
  return render(ui, { wrapper: AllProviders, ...options });
}

// Re-export everything from testing-library
export * from '@testing-library/react';
export { customRender as render };
```

### 4. Convex Mocking Strategy

**File: `__tests__/setup/mocks/convex.ts`**

```typescript
import { vi } from 'vitest';

// Mock useAuthActions hook
export const mockSignOut = vi.fn();
export const mockSignIn = vi.fn();

export const mockUseAuthActions = () => ({
  signOut: mockSignOut,
  signIn: mockSignIn,
});

// Reset all mocks between tests
export function resetConvexMocks() {
  mockSignOut.mockReset();
  mockSignIn.mockReset();
}
```

Usage in tests:
```typescript
vi.mock('@convex-dev/auth/react', () => ({
  useAuthActions: () => mockUseAuthActions(),
}));
```

### 5. Package.json Updates

**Scripts to add:**
```json
{
  "scripts": {
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage",
    "test:ui": "vitest --ui"
  }
}
```

**Dependencies to add:**
```json
{
  "devDependencies": {
    "vitest": "^3.0.0",
    "@vitejs/plugin-react": "^4.3.0",
    "@testing-library/react": "^16.0.0",
    "@testing-library/jest-dom": "^6.6.0",
    "@testing-library/user-event": "^14.5.0",
    "jsdom": "^26.0.0",
    "@vitest/coverage-v8": "^3.0.0"
  }
}
```

### 6. Sample Component Test

**File: `__tests__/components/auth/SignOutButton.test.tsx`**

```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { SignOutButton } from '@/components/auth/SignOutButton';

// Mock Next.js router
const mockPush = vi.fn();
vi.mock('next/navigation', () => ({
  useRouter: () => ({ push: mockPush }),
}));

// Mock Convex auth
const mockSignOut = vi.fn();
vi.mock('@convex-dev/auth/react', () => ({
  useAuthActions: () => ({ signOut: mockSignOut }),
}));

describe('SignOutButton', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('renders sign out button', () => {
    render(<SignOutButton />);
    expect(screen.getByRole('button', { name: /sign out/i })).toBeInTheDocument();
  });

  it('calls signOut and redirects on click', async () => {
    const user = userEvent.setup();
    mockSignOut.mockResolvedValueOnce(undefined);

    render(<SignOutButton />);
    await user.click(screen.getByRole('button', { name: /sign out/i }));

    expect(mockSignOut).toHaveBeenCalledTimes(1);
    expect(mockPush).toHaveBeenCalledWith('/');
  });

  it('shows loading state while signing out', async () => {
    const user = userEvent.setup();
    // Create a promise that doesn't resolve immediately
    let resolveSignOut: () => void;
    mockSignOut.mockImplementationOnce(() => new Promise(r => { resolveSignOut = r; }));

    render(<SignOutButton />);
    await user.click(screen.getByRole('button', { name: /sign out/i }));

    expect(screen.getByRole('button', { name: /signing out/i })).toBeDisabled();

    // Resolve and cleanup
    resolveSignOut!();
  });

  it('redirects to home even if signOut fails', async () => {
    const user = userEvent.setup();
    mockSignOut.mockRejectedValueOnce(new Error('Network error'));

    render(<SignOutButton />);
    await user.click(screen.getByRole('button', { name: /sign out/i }));

    expect(mockPush).toHaveBeenCalledWith('/');
  });
});
```

### 7. Sample Utility Test

**File: `lib/example.ts`**
```typescript
export function formatDisplayName(firstName: string, lastName?: string): string {
  if (!lastName) return firstName;
  return `${firstName} ${lastName}`;
}
```

**File: `__tests__/lib/example.test.ts`**
```typescript
import { describe, it, expect } from 'vitest';
import { formatDisplayName } from '@/lib/example';

describe('formatDisplayName', () => {
  it('returns first name only when no last name provided', () => {
    expect(formatDisplayName('John')).toBe('John');
  });

  it('returns full name when both provided', () => {
    expect(formatDisplayName('John', 'Doe')).toBe('John Doe');
  });

  it('handles empty strings', () => {
    expect(formatDisplayName('')).toBe('');
  });
});
```

## Implementation Strategy

### Phase 1: Core Setup (US-001, US-003)

1. Install dependencies via Bun
2. Create `vitest.config.ts` with path alias resolution
3. Create `vitest.setup.ts` with jest-dom and cleanup
4. Add test scripts to `package.json`
5. Create sample utility and test to verify setup works
6. Verify `bun test` runs and passes

### Phase 2: React Component Testing (US-002)

1. Create `__tests__/setup/test-utils.tsx` with custom render
2. Create `__tests__/setup/mocks/convex.ts` for Convex mocking
3. Create sample component test for `SignOutButton`
4. Verify component tests pass with mocked dependencies

### Phase 3: Watch Mode and DX (US-004)

1. Verify `bun test:watch` works correctly
2. Test file change detection
3. Document watch mode usage in README

### Phase 4: Coverage Reporting (US-005)

1. Install `@vitest/coverage-v8`
2. Configure coverage in `vitest.config.ts`
3. Add `test:coverage` script
4. Verify coverage report generation
5. Add `coverage/` to `.gitignore`

### Phase 5: Convex Function Testing (US-006) - Optional/Deferred

1. Research Convex testing utilities
2. Create mock context helpers
3. Add sample Convex function test
4. Document Convex testing patterns

## Testing Strategy

This feature IS the testing infrastructure, so validation is:

**Self-Verification:**
- `bun test` command works and exits 0 with passing tests
- Sample component test renders and asserts correctly
- Sample utility test imports and runs
- Watch mode detects changes
- Coverage report generates

**Manual Verification:**
- Path aliases (`@/components/...`) resolve in test files
- TypeScript types work in test files (no red squiggles)
- Test output is readable and informative

## Security Considerations

- No security implications - testing infrastructure only
- Test files should not contain real credentials
- Coverage reports excluded from git (may contain code snippets)

## Rollout Plan

### Deployment Strategy

1. Install dependencies on feature branch
2. Verify all quality gates pass (lint, typecheck)
3. Merge to main
4. No runtime deployment needed (dev tooling only)

### Migration Requirements

None - this is additive infrastructure.

### Monitoring

- Watch for test execution times during development
- Track coverage trends over time (optional)

### Rollback Plan

If issues arise:
1. Remove test dependencies from `package.json`
2. Delete `vitest.config.ts`, `vitest.setup.ts`
3. Remove `__tests__/` directory
4. Run `bun install` to update lockfile

## Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| vitest | ^3.0.0 | Test runner |
| @vitejs/plugin-react | ^4.3.0 | React JSX transform for Vitest |
| @testing-library/react | ^16.0.0 | React component testing |
| @testing-library/jest-dom | ^6.6.0 | DOM assertion matchers |
| @testing-library/user-event | ^14.5.0 | User interaction simulation |
| jsdom | ^26.0.0 | DOM environment |
| @vitest/coverage-v8 | ^3.0.0 | Coverage reporting |

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| React 19 compatibility issues | Low | High | Use latest RTL version, test early |
| Bun/Vitest integration issues | Low | Medium | Vitest officially supports Bun |
| Next.js App Router mocking complexity | Medium | Medium | Start with simple components, document patterns |
| Convex hook mocking complexity | Medium | Low | Use vi.mock, defer complex tests to P3 |

## Notes

- This feature unblocks TDD for all future features
- Keep sample tests as documentation of testing patterns
- Consider adding Vitest UI (`vitest --ui`) for interactive debugging later
