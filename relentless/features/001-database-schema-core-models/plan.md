# Implementation Plan: Database Schema & Core Models

**Branch**: `001-database-schema-core-models` | **Date**: 2026-01-16 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `relentless/features/001-database-schema-core-models/spec.md`

## Summary

Define the complete Convex database schema for Alongside AI, including 9 tables: profiles, events, projects, experiments, articles, videos, playlists, tags, and testimonials. Establish role-based access control (admin/member/guest) and profile visibility states (locked/unlocked/published). The schema extends the existing `authTables` from `@convex-dev/auth` and follows Convex best practices for validators, indexes, and type safety.

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode)
**Primary Dependencies**: Convex, @convex-dev/auth
**Storage**: Convex (real-time database)
**Testing**: Convex test framework, TypeScript type checking
**Target Platform**: Web (Next.js 16)
**Project Type**: Web application (Next.js frontend + Convex backend)
**Performance Goals**: Real-time updates, indexed queries
**Constraints**: All queries must use indexes (no filter()), all functions require args/returns validators
**Scale/Scope**: MVP targeting 100s of users, 1000s of content items

## Constitution Check

*GATE: Must pass before implementation.*

| Principle | Requirement | Compliance |
|-----------|-------------|------------|
| Type Safety | All Convex functions must have `args` and `returns` validators | ✅ Schema uses `v.` validators |
| Type Safety | Use `Id<"tableName">` for document IDs | ✅ Schema uses `v.id("tableName")` |
| Type Safety | Use `v.null()` for void returns | ✅ Will apply to helper functions |
| Convex Backend | Define schema in `convex/schema.ts` | ✅ Single schema file |
| Convex Backend | Use `withIndex()` instead of `filter()` | ✅ All query patterns have indexes |
| Convex Backend | Include index fields in index names | ✅ e.g., `by_userId`, `by_slug` |
| Code Quality | Pass TypeScript typecheck with 0 errors | ✅ Will validate after implementation |
| Code Quality | Pass `bun run lint` with 0 warnings | ✅ Will validate after implementation |

**Constitution Compliance: PASS**

## Project Structure

### Documentation (this feature)

```text
relentless/features/001-database-schema-core-models/
├── spec.md              # Feature specification
├── clarification-log.md # Clarified decisions
├── plan.md              # This file
└── tasks.md             # Generated by /relentless.tasks
```

### Source Code

```text
convex/
├── _generated/          # Auto-generated types (do not edit)
├── schema.ts            # Database schema (PRIMARY DELIVERABLE)
├── auth.ts              # Auth configuration (existing)
├── auth.config.ts       # Auth providers (existing)
├── http.ts              # HTTP endpoints (existing)
└── lib/                 # Shared utilities (new)
    └── validators.ts    # Reusable validator patterns
```

**Structure Decision**: Schema-only feature. All code goes in `convex/schema.ts` with optional shared validators in `convex/lib/validators.ts`.

## Data Models

### Entity Relationship Diagram

```
┌──────────────┐     ┌──────────────┐
│    users     │     │   profiles   │
│  (authTables)│◄────│              │
└──────────────┘     └──────┬───────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   projects   │     │   articles   │     │    videos    │
└──────┬───────┘     └──────┬───────┘     └──────┬───────┘
       │                    │                    │
       │     ┌──────────────┼──────────────┐     │
       │     │              │              │     │
       ▼     ▼              ▼              ▼     ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│     tags     │     │ testimonials │     │  playlists   │
└──────────────┘     └──────┬───────┘     └──────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │    events    │
                     └──────────────┘
```

### Table Definitions

#### 1. profiles

Links auth users to extended profile data with role-based access control.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| userId | `Id<"users">` | Yes | Foreign key to auth users table |
| role | `"admin" \| "member" \| "guest"` | Yes | User role for authorization |
| profileStatus | `"locked" \| "unlocked" \| "published"` | Yes | Profile visibility state |
| displayName | `string` | No | Public display name |
| bio | `string` | No | User biography |
| photoUrl | `string` | No | Profile photo URL |
| socialLinks | `object` | No | LinkedIn, Twitter, GitHub, website URLs |
| workingOnNow | `string` | No | Current project description |
| skills | `string[]` | No | List of skills/interests |
| location | `string` | No | Geographic location |

**Indexes:**
- `by_userId` - Look up profile by auth user
- `by_role` - Query users by role (admin users, etc.)
- `by_profileStatus` - Query published profiles for directory

#### 2. events

Primary revenue entity for educational events.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| title | `string` | Yes | Event title |
| slug | `string` | Yes | URL-friendly identifier |
| description | `string` | Yes | Rich text description |
| date | `number` | Yes | Start timestamp (Unix ms) |
| endDate | `number` | No | End timestamp for multi-day events |
| timezone | `string` | Yes | IANA timezone (e.g., "America/New_York") |
| location | `string` | Yes | Physical address or "Virtual" |
| isVirtual | `boolean` | Yes | Virtual vs in-person flag |
| agenda | `string` | No | Event schedule/agenda |
| priceInCents | `number` | Yes | Price in cents (0 for free) |
| capacity | `number` | No | Maximum attendees |
| speakerIds | `Id<"profiles">[]` | No | Speaker profile references |
| tags | `Id<"tags">[]` | No | Category tags |
| isFeatured | `boolean` | No | Homepage feature flag |
| isArchived | `boolean` | No | Soft archive for past events |

**Indexes:**
- `by_slug` - URL routing
- `by_date` - Chronological listing, upcoming vs past
- `by_isFeatured_and_date` - Featured events sorted by date

#### 3. projects

Completed work showcase.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| title | `string` | Yes | Project title |
| slug | `string` | Yes | URL-friendly identifier |
| description | `string` | Yes | Short description |
| heroImageUrl | `string` | No | Hero image URL |
| heroVideoUrl | `string` | No | Hero video URL |
| caseStudy | `string` | No | Rich text case study |
| demoUrl | `string` | No | Live demo link |
| repoUrl | `string` | No | Repository link |
| youtubeEmbeds | `string[]` | No | YouTube video IDs |
| authorId | `Id<"profiles">` | Yes | Author profile reference |
| tags | `Id<"tags">[]` | No | Category tags |
| isPublished | `boolean` | Yes | Draft/published state |
| isFeatured | `boolean` | No | Homepage feature flag |

**Indexes:**
- `by_slug` - URL routing
- `by_authorId` - Author's projects
- `by_isPublished` - Public projects only
- `by_isFeatured` - Featured projects

#### 4. experiments

In-progress work with status tracking.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| title | `string` | Yes | Experiment title |
| slug | `string` | Yes | URL-friendly identifier |
| description | `string` | Yes | Short description |
| heroImageUrl | `string` | No | Hero image URL |
| heroVideoUrl | `string` | No | Hero video URL |
| status | `"exploring" \| "prototyping" \| "paused" \| "concluded"` | Yes | Current status |
| learningLog | `string` | No | Progress updates |
| figuringOut | `string` | No | Current challenges |
| demoUrl | `string` | No | Live demo link |
| repoUrl | `string` | No | Repository link |
| youtubeEmbeds | `string[]` | No | YouTube video IDs |
| authorId | `Id<"profiles">` | Yes | Author profile reference |
| tags | `Id<"tags">[]` | No | Category tags |
| isPublished | `boolean` | Yes | Draft/published state |
| isFeatured | `boolean` | No | Homepage feature flag |

**Indexes:**
- `by_slug` - URL routing
- `by_authorId` - Author's experiments
- `by_status` - Filter by status
- `by_isPublished` - Public experiments only

#### 5. articles

Blog content from Substack.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| title | `string` | Yes | Article title |
| slug | `string` | Yes | URL-friendly identifier |
| content | `string` | Yes | Full article content (Markdown/HTML) |
| excerpt | `string` | No | Short preview text |
| authorId | `Id<"profiles">` | Yes | Author profile reference |
| tags | `Id<"tags">[]` | No | Category tags |
| substackUrl | `string` | No | Link back to Substack |
| publishedAt | `number` | Yes | Publication timestamp |
| isFeatured | `boolean` | No | Homepage feature flag |

**Indexes:**
- `by_slug` - URL routing
- `by_authorId` - Author's articles
- `by_publishedAt` - Chronological listing
- `by_isFeatured_and_publishedAt` - Featured articles sorted by date

#### 6. videos

YouTube-hosted educational content.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| title | `string` | Yes | Video title |
| slug | `string` | Yes | URL-friendly identifier |
| description | `string` | No | Video description |
| youtubeId | `string` | Yes | YouTube video ID |
| playlistId | `Id<"playlists">` | No | Playlist grouping |
| duration | `number` | No | Duration in seconds |
| authorId | `Id<"profiles">` | Yes | Author profile reference |
| tags | `Id<"tags">[]` | No | Category tags |
| isPublished | `boolean` | Yes | Draft/published state |
| isFeatured | `boolean` | No | Homepage feature flag |

**Indexes:**
- `by_slug` - URL routing
- `by_authorId` - Author's videos
- `by_playlistId` - Videos in playlist
- `by_isPublished` - Public videos only
- `by_isFeatured` - Featured videos

#### 7. playlists

Video series groupings.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| title | `string` | Yes | Playlist title |
| slug | `string` | Yes | URL-friendly identifier |
| description | `string` | No | Playlist description |
| displayOrder | `number` | No | Sort order |

**Indexes:**
- `by_slug` - URL routing

#### 8. tags

Unified taxonomy across content types.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| name | `string` | Yes | Display name (e.g., "LangChain") |
| slug | `string` | Yes | URL-friendly identifier |
| description | `string` | No | Tag description |

**Indexes:**
- `by_slug` - URL routing, tag pages
- `by_name` - Lookup by name

#### 9. testimonials

Social proof quotes.

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| quote | `string` | Yes | Testimonial text |
| authorName | `string` | Yes | Person's name |
| authorRole | `string` | No | Job title |
| authorCompany | `string` | No | Company name |
| authorPhotoUrl | `string` | No | Photo URL |
| eventId | `Id<"events">` | No | Associated event |
| displayOrder | `number` | No | Sort order for display |
| isFeatured | `boolean` | No | Homepage feature flag |

**Indexes:**
- `by_eventId` - Event-specific testimonials
- `by_isFeatured` - Featured testimonials
- `by_displayOrder` - Ordered display

## Implementation Strategy

### Phase 1: Schema Definition (Primary)

1. **Update `convex/schema.ts`**
   - Remove placeholder `numbers` table
   - Keep `...authTables` spread
   - Add all 9 new table definitions
   - Define all indexes

2. **Validate Schema**
   - Run `bunx convex dev` to deploy schema
   - Verify no TypeScript errors
   - Confirm indexes are created

### Phase 2: Helper Functions (Optional)

1. **Create `convex/lib/validators.ts`**
   - Extract reusable validator patterns
   - Define shared enums (role, profileStatus, experimentStatus)

2. **Type Exports**
   - Export TypeScript types for frontend use
   - Document type usage patterns

## API Contracts

This feature is schema-only. No new API endpoints are created. Future features will define queries/mutations using this schema.

### Expected Query Patterns

| Pattern | Table | Index Used |
|---------|-------|------------|
| Get profile by user ID | profiles | `by_userId` |
| List admin users | profiles | `by_role` |
| List published profiles | profiles | `by_profileStatus` |
| Get event by slug | events | `by_slug` |
| List upcoming events | events | `by_date` |
| List featured events | events | `by_isFeatured_and_date` |
| Get project by slug | projects | `by_slug` |
| List author's projects | projects | `by_authorId` |
| List published projects | projects | `by_isPublished` |
| Get tag by slug | tags | `by_slug` |
| List event testimonials | testimonials | `by_eventId` |

## Testing Strategy

### Type Checking (Required)

```bash
# Must pass with 0 errors
bunx tsc --noEmit
```

### Schema Deployment Test

```bash
# Must deploy without errors
bunx convex dev
```

### Manual Validation

1. **Insert Test Data**
   - Use Convex Dashboard to insert sample documents
   - Verify all validators work correctly
   - Test required vs optional fields

2. **Index Verification**
   - Query using each defined index
   - Verify efficient query execution

### Test Data Requirements

| Table | Minimum Test Records |
|-------|---------------------|
| profiles | 3 (one per role) |
| events | 2 (upcoming, past) |
| projects | 2 (published, draft) |
| tags | 5 |
| testimonials | 2 |

## Security Considerations

### Authorization Model

| Role | Capabilities |
|------|-------------|
| `admin` | Full CRUD on all content, user management |
| `member` | View published content, edit own profile |
| `guest` | View published content only |

### Data Validation

- All string fields use `v.string()` with no max length (Convex handles 1MB limit)
- URLs validated at application layer (not schema)
- Timestamps stored as Unix milliseconds (`v.number()`)
- Prices stored in cents to avoid floating-point issues

### Profile Privacy

| Status | Visibility |
|--------|------------|
| `locked` | Not visible, not editable |
| `unlocked` | Editable by owner, not publicly visible |
| `published` | Visible in community directory |

## Rollout Plan

### Deployment Strategy

1. **Development**
   - Deploy schema changes via `bunx convex dev`
   - Convex handles schema migrations automatically

2. **Production**
   - Deploy via `bunx convex deploy`
   - No downtime expected for additive schema changes

### Migration Requirements

- **From current state**: Remove `numbers` table (if unused)
- **No data migration needed**: New tables, no existing data to transform

### Monitoring

- Convex Dashboard for query performance
- TypeScript compiler for type safety
- ESLint for code quality

### Rollback Plan

- Convex schema changes are additive
- Tables can be removed if unused
- No destructive migrations in this feature

## Complexity Tracking

No constitution violations. This feature follows all MUST requirements:
- Single schema file
- Proper validators
- Indexed queries
- Type safety

## Notes

- The `numbers` table in the existing schema appears to be a placeholder from project setup and should be removed
- All timestamps use Unix milliseconds for consistency with Convex `_creationTime`
- Profile creation logic (FR-015) will be implemented in the Authentication feature (F02)
- Slug generation logic will be implemented in respective content management features
